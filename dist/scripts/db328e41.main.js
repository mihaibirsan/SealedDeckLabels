"use strict";function fitString(a,b){return"undefined"==typeof b&&(b=18),"string"!=typeof a?a:a.substr(0,b)}function lpad(a,b,c){if("string"!=typeof a)return a;for(;a.length<c;)a=b+a;return a}function pageDistribution(a,b,c){c=c||1;var d,e,f=Math.ceil(a/b),g=(Math.ceil(a/f),[]);for(d=0;f>d;d++)g.push([]);for(d=0;a>d;)for(e=0;a>d&&c>e;d++,e++)g[(d-e)/c%f].push(d);return g}function renderMasterList(a,b){return renderMasterList_Individual(a,b)}function renderMasterList_Individual(a,b){var c,d,e,f=new jsPDF,g=27,h=25,i=10,j=80,k=7,l=Math.floor((297-g-i)/k),m=2,n=0,o=Math.ceil(a.players.length/(l*m));return _(a.players).chain().sortBy("playerName").each(function(a,i){if(n>=b)return!1;if(e=i%(l*m),0===e){if(n++,n>b)return!1;i&&f.addPage(),f.header("Master List ("+n+" of "+o+")")}c=Math.floor(e/l)*j,d=e%l*k,f.player(a,{x:c+h,y:d+g,width:j,height:k})}),f}function renderMasterList_TeamGroups(a,b){var c,d,e,f=new jsPDF,g=($('<div class="render-helper-master-list"></div>'),27),h=10,i=100,j=25,k=Math.floor((297-g-h)/j),l=2,m=0,n=Math.ceil(a.teams.length/(k*l));return _(a.teams).chain().sortBy("teamName").each(function(a,o){if(m>=b)return!1;if(e=o%(k*l),0===e){if(m++,m>b)return!1;o&&f.addPage(),f.header("Master List ("+m+" of "+n+")")}c=Math.floor(e/k)*i,d=e%k*j,f.team(a,{x:c+h,y:d+g,width:i,height:j})}),f}function renderLabels(a,b){return renderLabels_Individual(a,b)}function renderLabels_Individual(a,b){var c=new jsPDF,d={width:60,height:27,labelAcross:3,labelAround:8,topMargin:6,bottomMargin:5,leftMargin:8,rightMargin:8,gapAcross:7,gapAround:10,cornerRadius:0},e=2,f=_(a.players).sortBy("tableNumber"),g=_.chain(pageDistribution(f.length,d.labelAround,e)).map(function(a){return _.chain(a).map(function(a){return f[a]}).map(function(a){var b=[];return b.push(["playerRegistering",a]),b.push(["playerPlaying",a]),b.push(["playerBackup",a]),b}).flatten(!0).value()}).value();"undefined"!=typeof b&&(g=g.slice(0,b));var h=_.range(d.labelAround/e+1),i=0,j=0;return _.each(g,function(a,b){_.each(a,function(a,e){i+=d.width+d.gapAcross,e%d.labelAcross===0&&(i=d.leftMargin,j+=d.height+d.gapAround),0===e&&(b&&(c.previewPrecut(),c.addPage()),i=d.leftMargin,j=d.topMargin);var f=a.shift();a.push($.extend({},d,{x:i,y:j})),c[f].apply(c,a)}),_.each(h,function(a){})}),c}function renderLabels_Teams4by4(a,b){var c=new jsPDF,d={width:45.7,height:25.5,labelAcross:4,labelAround:10,topMargin:21,bottomMargin:21,leftMargin:10.6,rightMargin:10.6,gapAround:0,gapAcross:2,cornerRadius:1.5},e=2,f=_.chain(pageDistribution(a.teams.length,d.labelAround,e)).map(function(b){return _.chain(b).map(function(b){return a.teams[b]}).map(function(a){var b=[];return b.push(["teamRegistering",a]),_.each(a.players,function(c){b.push(["teamPlaying",a,c])}),b}).flatten(!0).value()}).value();"undefined"!=typeof b&&(f=f.slice(0,b));var g=_.range(d.labelAround/e+1),h=0,i=0;return _.each(f,function(a,b){_.each(a,function(a,e){h+=d.width+d.gapAcross,e%d.labelAcross===0&&(h=d.leftMargin,i+=d.height+d.gapAround),0===e&&(b&&c.addPage(),h=d.leftMargin,i=d.topMargin);var f=a.shift();a.push($.extend({},d,{x:h,y:i})),c[f].apply(c,a)}),_.each(g,function(a){c.horizontalCutMarks(a*(d.height+d.gapAround)*e+d.topMargin)})}),c}function updatePreview(){var a;a=$('input[name="preview-type"][value="master-list"]').get(0).checked?renderMasterList(model,2):renderLabels(model,2),$(".preview-pane").attr("src",a.output("datauristring"))}function openFile(){var a=$(".system input[type=file]");a.off("change");var b,c=Q.defer(),d=new FileReader;return d.onload=function(a){c.resolve(a.target.result,b)},a.one("change",function(){a[0].files.length>0&&(b=a[0].files[0].name,d.readAsText(a[0].files[0]))}),a[0].click(),c.promise}function parsePlayersFile(a,b){b&&!b.match(/302\.txt$/)&&console.warn("You might be using an unrecognized players file!");var c=_.chain(a.split(/\n/)).map(function(a){return a.match(/^\s*$/)?void 0:a.split(/\t/)}).compact().map(function(a){return{playerId:a[0],playerName:a[6],dcinum:a[8]}}).value();return model.players=c,c}function clearPlayers(){model.players=[],model.teams=[]}function parseTeamsFile(a,b){b&&!b.match(/307\.txt$/)&&console.warn("You might be using an unrecognized teams file!");var c=0,d=_.chain(a.split(/\n/)).map(function(a){return a.match(/^\s*$/)?void 0:a.split(/\t/)}).compact().map(function(a){return{teamName:a[4],players:[a[14],a[15],a[16]]}}).map(function(a){return a.players=_(a.players).map(function(a){return c+=.5,_.extend({},_.findWhere(model.players,{playerId:a}),{tableNumber:Math.ceil(c)})}),a}).value();return model.teams=d,d}function parseWERFile(a,b){var c=$.parseXML(a),d=$(c),e=0,f=[],g=_.chain(d.find("team").toArray()).map(function(a){return{teamName:$(a).attr("name"),players:$(a).find("member").toArray()}}).map(function(a){return a.players=_(a.players).map(function(a){var b=d.find('person[id="'+$(a).attr("person")+'"]');e+=.5;var c={playerId:b.attr("id"),playerName:b.attr("last")+", "+b.attr("first"),dcinum:b.attr("id"),tableNumber:Math.ceil(e)};return f.push(c),c}),a}).value();return _(d.find("seats seat").toArray()).map(function(a){var b=$(a).attr("player"),c=$(a).closest("table").attr("number"),d=_(f).findWhere({playerId:b});d.tableNumber=parseInt(c)}),model.players=f,model.teams=g,g}function clearTeams(){model.teams=[]}function updateView(){$(".p-players-list-empty").toggle(0===model.players.length),$(".p-players-list-loaded").toggle(model.players.length>0),$(".player-count").text(model.players.length),$(".p-teams-list-empty").toggle(model.players.length>0&&0===model.teams.length),$(".p-teams-list-loaded").toggle(model.players.length>0&&model.teams.length>0),$(".team-count").text(model.teams.length)}var model={players:[],teams:[]};jsPDF.API.playerRegistering=function(a,b){b=_.extend({x:10,y:10,width:40,height:20,cornerRadius:1.5,title:"PLAYER REGISTERING DECK"},b),this.roundedRect(b.x,b.y,b.width,b.height,b.cornerRadius,b.cornerRadius);var c=5;this.roundedRect(b.x,b.y+c,b.width,b.height-c,b.cornerRadius,b.cornerRadius),this.setFont("helvetica","bold"),this.setFontSize(10),this.text(b.x+1,b.y+4,b.title);var d=a.playerName.split(/, /,2);this.setFont("courier","normal"),this.setFontSize(12),this.text(b.x+1,b.y+9,fitString(d[0])+"\n"+fitString(d[1])+"\n"+a.dcinum),this.setFont("helvetica","bold"),this.setFontSize(24),this.text(b.x+b.width-3,b.y+b.height-3,lpad(""+a.tableNumber,"0",3),90)},jsPDF.API.playerPlaying=function(a,b){return b=_.extend({title:"PLAYER USING DECK"},b),this.playerRegistering(a,b)},jsPDF.API.playerBackup=function(a,b){return b=_.extend({title:""},b),this.playerRegistering(a,b)},jsPDF.API.teamRegistering=function(a,b){_.extend({x:10,y:10,width:40,height:20,cornerRadius:1.5},b),this.roundedRect(b.x,b.y,b.width,b.height,b.cornerRadius,b.cornerRadius);var c=5;this.roundedRect(b.x,b.y+c,b.width,b.height-c,b.cornerRadius,b.cornerRadius),this.setFont("helvetica","bold"),this.setFontSize(10),this.text(b.x+1,b.y+4,"TEAM REGISTERING"),this.setFont("courier","normal"),this.setFontSize(12),this.text(b.x+1,b.y+9,fitString(a.teamName,17))},jsPDF.API.teamPlaying=function(a,b,c){$.extend({x:10,y:10,width:40,height:20,cornerRadius:1.5},c);var d=b.playerName.split(/, /,2);this.roundedRect(c.x,c.y,c.width,c.height,c.cornerRadius,c.cornerRadius);var e=5;this.roundedRect(c.x,c.y,c.width-e,c.height-e,c.cornerRadius,c.cornerRadius),this.setFont("helvetica","normal"),this.setFontSize(10),this.text(c.x+1,c.y+c.height-1,"PLAYER USING DECK"),this.setFont("helvetica","bold"),this.setFontSize(12),this.text(c.x+c.width-1,c.y+c.height/2,lpad(""+b.tableNumber,"0",3),90),this.setFont("courier","normal"),this.setFontSize(12),this.text(c.x+1,c.y+4,fitString(a.teamName,15)),this.setFontSize(10),this.setFont("courier","bold"),this.text(c.x+1,c.y+11,fitString(d[0])+"\n"+fitString(d[1])+"\n"+b.dcinum)},jsPDF.API.horizontalCutMarks=function(a){for(var b=15,c=3,d=b/(2*c-1),e=0;c>e;e++)this.lines([[d,0]],d*e*2,a),this.lines([[d,0]],210-b+d*e*2,a)},jsPDF.API.previewPrecut=function(){return},jsPDF.API.header=function(a){this.setFont("helvetica","bold"),this.setFontSize(12),this.text(80,20,a)},jsPDF.API.player=function a(a,b){$.extend({x:10,y:10,width:100,height:40},b),this.setFont("helvetica","normal"),this.setFontSize(10),this.text(b.x+1,b.y+6,lpad(""+a.tableNumber,"0",3)),this.text(b.x+11,b.y+6,fitString(a.playerName,30))},jsPDF.API.team=function b(b,a){$.extend({x:10,y:10,width:100,height:40},a),this.setFont("helvetica","normal"),this.setFontSize(10),this.text(a.x+1,a.y+6,lpad(""+b.players[0].tableNumber,"0",3)),this.setFontStyle("bold"),this.text(a.x+11,a.y+6,fitString(b.teamName,30)),this.setFontStyle("normal"),_.each(b.players,function(b,c){this.text(a.x+21,a.y+6+5*(c+1),fitString(b.playerName,30))},this)},updateView(),$(document).on("click",".action-load-wer-file",function(a){a.preventDefault(),openFile().then(parseWERFile).then(updatePreview).then(updateView).done()}),$(document).on("click",".action-load-players",function(a){a.preventDefault(),openFile().then(parsePlayersFile).then(updatePreview).then(updateView).done()}),$(document).on("click",".action-clear-players",function(a){a.preventDefault(),clearPlayers(),updatePreview(),updateView()}),$(document).on("click",".action-load-teams",function(a){a.preventDefault(),openFile().then(parseTeamsFile).then(updatePreview).then(updateView).done(),updateView()}),$(document).on("click",".action-clear-teams",function(a){a.preventDefault(),clearTeams(),updatePreview(),updateView()}),$(document).on("click",".action-refresh",function(a){updatePreview()}),$(document).on("change",".onchange-refresh",function(a){updatePreview()}),$(document).on("click",".action-download-master-list",function(a){a.preventDefault();var b=renderMasterList(model);b.save("master-list.pdf")}),$(document).on("click",".action-download-labels",function(a){a.preventDefault();var b=renderLabels(model);b.save("labels.pdf")}),$(document).on("click",".action-toggle-fullscreen",function(a){a.preventDefault(),$("body").toggleClass("preview-pane-fullscreen")});